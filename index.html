<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»šæˆ¿è¨‚å–®é¡¯ç¤º</title>
    <style>
        body { font-family: Arial; }
        .order { border: 1px solid #000; padding: 10px; margin: 10px; background: lightyellow; transition: 0.3s; }
        .completed-item { text-decoration: line-through; color: gray; }
        .completedorder { opacity: 0.5; }
        #pendingOrders, #completedOrders { margin-top: 20px; }
    </style>
</head>
<body>
    <h2>å³æ™‚è¨‚å–®</h2>
    <button id="syncorders">æ›´æ–°è¨‚å–®</button>

    <h3>å¾…å®Œæˆ</h3>
    <ul id="item-counts"></ul>

    <div id="pendingOrders">
        <h3>æœªå®Œæˆè¨‚å–®</h3>
        <div id="pending-list"></div>
    </div>

    <div id="completedOrders">
        <h3>å·²å®Œæˆè¨‚å–®</h3>
        <div id="completed-list"></div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycby66Rk0xjKybpUno8AbIhfVvHyriChiipxG6ccjtMC1j6Ybhc1y2meqltUL6gBIBVc/exec"; 
        let orders = [];
        let itemCounts = {};
        let completedItems = JSON.parse(localStorage.getItem("completedItems")) || {}; // å¾ localStorage è®€å–å·²å®Œæˆå“é …

        async function fetchOrder() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("API å›æ‡‰éŒ¯èª¤");
                const newOrders = await response.json();

                console.log("âœ… API å›æ‡‰:", newOrders);

                orders = newOrders.map(order => {
                    order.items.forEach((item, index) => {
                        const itemKey = `${order.orderId}-${index}`;
                        if (completedItems[itemKey]) {
                            item.completed = true; // æ¢å¾©å·²å®Œæˆç‹€æ…‹
                        }
                    });
                    return order;
                });

                renderOrders();
                updateItemCounts();
            } catch (error) {
                console.error("âŒ è®€å– API å¤±æ•—:", error);
            }
        }

        function renderOrders() {
            document.getElementById("pending-list").innerHTML = "";
            document.getElementById("completed-list").innerHTML = "";
            orders.forEach(order => addOrder(order));
        }

        function addOrder(order) {
            const div = document.createElement("div");
            div.className = "order";
            div.dataset.orderId = order.orderId;

            let itemsHtml = `<strong>æ¡Œè™Ÿï¼š${order.table} è¨‚å–®ç·¨è™Ÿï¼š${order.orderId}</strong><br>`;
            order.items.forEach((item, index) => {
                const itemClass = item.completed ? "completed-item" : "";
                itemsHtml += `
                    <p id="order-${order.orderId}-item-${index}" class="${itemClass}">
                        ${item.name} x ${item.quantity}
                        <button class="complete-btn" data-order-id="${order.orderId}" data-item-index="${index}" ${item.completed ? "disabled" : ""}>
                            å®Œæˆ
                        </button>
                    </p>`;
            });

            div.innerHTML = itemsHtml;
            if (order.items.every(item => item.completed)) {
                document.getElementById("completed-list").appendChild(div);
            } else {
                document.getElementById("pending-list").appendChild(div);
            }
        }

        function markItemComplete(orderId, itemIndex) {
            orderId = parseInt(orderId, 10);
            itemIndex = parseInt(itemIndex, 10);

            console.log(`ğŸ“Œ æ¨™è¨˜å®Œæˆï¼šè¨‚å–® ${orderId}ï¼Œå“é …ç´¢å¼• ${itemIndex}`);

            const order = orders.find(o => o.orderId === orderId);
            if (!order) return console.error(`âŒ æ‰¾ä¸åˆ°è¨‚å–® ${orderId}`);

            const item = order.items[itemIndex];
            if (!item) return console.error(`âŒ æ‰¾ä¸åˆ°å“é …ç´¢å¼• ${itemIndex}ï¼Œè¨‚å–® ${orderId}`);

            item.completed = true;
            completedItems[`${orderId}-${itemIndex}`] = true; // è¨˜éŒ„å®Œæˆç‹€æ…‹
            localStorage.setItem("completedItems", JSON.stringify(completedItems)); // å­˜å…¥ localStorage

            const itemElement = document.getElementById(`order-${orderId}-item-${itemIndex}`);
            if (itemElement) {
                itemElement.classList.add("completed-item");
                const button = itemElement.querySelector("button");
                if (button) button.disabled = true;
            } else {
                console.error("âŒ æ‰¾ä¸åˆ°å°æ‡‰çš„é …ç›®å…ƒç´ ï¼");
            }

            updateItemCounts();
            checkOrderCompletion(orderId);
        }

        function updateItemCounts() {
            itemCounts = {};
            orders.forEach(order => {
                order.items.forEach(item => {
                    if (!item.completed) {
                        itemCounts[item.name] = (itemCounts[item.name] || 0) + item.quantity;
                    }
                });
            });

            const itemCountsDiv = document.getElementById("item-counts");
            itemCountsDiv.innerHTML = "";
            for (const [item, count] of Object.entries(itemCounts)) {
                const li = document.createElement("li");
                li.textContent = `${item}ï¼š${count} ä»½`;
                itemCountsDiv.appendChild(li);
            }
        }

        function checkOrderCompletion(orderId) {
            const order = orders.find(o => o.orderId === orderId);
            if (!order) return;

            if (order.items.every(item => item.completed)) {
                moveOrderToCompleted(orderId);
            }
        }

        function moveOrderToCompleted(orderId) {
            const orderDiv = document.querySelector(`.order[data-order-id='${orderId}']`);
            if (!orderDiv) return;

            orderDiv.classList.add("completedorder");
            document.getElementById("completed-list").appendChild(orderDiv);
        }

        document.getElementById("syncorders").addEventListener("click", fetchOrder);
        document.addEventListener("click", function (event) {
            if (event.target.classList.contains("complete-btn")) {
                const orderId = parseInt(event.target.dataset.orderId, 10);
                const itemIndex = parseInt(event.target.dataset.itemIndex, 10);
                markItemComplete(orderId, itemIndex);
            }
        });

        setInterval(fetchOrder, 5000);
        fetchOrder();
    </script>
</body>
</html>